<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>

		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />

		<style type="text/css">
			html,
			body {
				background-color: #efeff4;
			}
			
			.dizhi-img {
				margin-top: 10px;
				width: 40px;
			}
			
			.leftClassCell {
				width: 30%;
				float: left;
				line-height: 100px;
				display: table-cell;
			}
			
			.rightClassCell {
				width: 55%;
				float: left;
			}
			
			.ClassCell {
				width: 15%;
				float: left;
				line-height: 100px;
			}
			
			.itemName {
				color: black;
				margin-top: 10px;
				line-height: 1.5em;
			}
			
			.price {
				line-height: 1.5em;
				margin-right: 2px;
				display: inline;
			}
			
			.guige {
				line-height: 1.5em;
				/*margin-top: 15px;*/
				/*display: inline;*/
				/*vertical-align: middle;*/
			}
			
			.mui-table-view-cell .mui-media {
				padding: 0px;
			}
			
			.mui-table-view:before {
				height: 0px;
			}
			
			.mui-table-view-chevron:after {
				height: 0px;
			}
			
			.cellImg {
				max-width: 70%;
				vertical-align: middle;
				margin-left: 12px;
			}
			
			.shuliang {
				float: right;
				margin-right: 20px;
				/*text-align: right;*/
			}
			
			.button-style {
				vertical-align: middle;
				padding: 3px 24px;
				border-radius: 20px;
			}
			
			.button-cancle {
				vertical-align: middle;
				padding: 3px 10px;
				border-radius: 20px;
			}
			
			.leftButton {
				width: 70%;
				float: left;
				line-height: 40px;
				text-align: right;
			}
			
			.rightButton {
				width: 30%;
				float: left;
				line-height: 40px;
				text-align: right;
				padding-right: 20px;
			}
			
			.bottom-bar {
				position: fixed;
				/*width: 100%;*/
				bottom: 0px;
				left: 0px;
				right: 0px;
				background: white;
				height: 44px;
				line-height: 44px;
				color: #fff;
				font-size: 16px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">订单详情</h1>
		</header>
		<ul id="info" class="mui-table-view mui-table-view-chevron" style="margin-top: 44px;margin-bottom: 7px;">
			<li class="mui-table-view-cell mui-media" style="height: auto;padding: 0px;">
				<div style="width: 15%;float: left;vertical-align: middle;line-height: 80px;">
					<!--<img src="../images/yizhan_shouhuodizhi.png" style="width:70%;vertical-align: middle;margin-left: 18%;">-->
					<span class="mui-icon iconfont icon-map" style="font-size:30px;vertical-align: middle;margin-left: 18%;"></span>
				</div>
				<div class="mui-media-body" style="width: 85%;float: left;line-height: 1.5em;">
					<p id="people" style="width: 70%;float: left;padding-top: 4%;color: black;"></p>
					<p id="phone" style="width: 30%;float: left;padding-top: 4%;color: black;"></p>
					<p id="shouhuodizhi" style="word-wrap: break-word;padding-right: 4%;color: black;"></p>
				</div>
			</li>
			<!--<li class="mui-table-view-cell mui-media" style="height: auto;padding: 0px;">
				<div style="width: 15%;float: left;vertical-align: middle;line-height: 80px;">
					<span class="mui-icon iconfont icon-liuyan" style="font-size:30px;vertical-align: middle;margin-left: 18%;"></span>
				</div>
				<div class="mui-media-body" style="width: 85%;float: left;line-height: 1.5em;">
					<p id="people" style="padding-top: 4%;color: black;">买家留言</p>
					<p id="shouhuodizhi" style="word-wrap: break-word;padding-right: 4%;color: black;">4444</p>
				</div>
			</li>-->
		</ul>

		<div>
			<div>
				<ul id="DingdanList" class="mui-table-view">
					<!--<li class="mui-table-view-cell mui-media" style="">
							<div class="leftClassCell">
								<img src="../images/banjin.jpg" class="cellImg" />
							</div>
							<div class="rightClassCell">
								<p class="itemName mui-ellipsis-2">今麦郎方便面108g</p>
								<p class="price">¥5</p>
							</div>
							<div class="ClassCell">
								<p class="count">x1</p>
							</div>
						</li>-->
				</ul>
			</div>
		</div>
		<div style="background: white;height: 40px;">
			<div style="width: 85%;float: left;line-height: 40px;padding-left: 10px;">
				<p style="color: black;">订单总价：</p>
			</div>
			<div style="width: 15%;float: left;line-height: 40px;">
				<p id="total-price" style="color: red;"></p>
			</div>
		</div>
		<div style="background: white;margin-top: 7px;padding: 12px;margin-bottom: 44px;">
			<p style="display: inline;color: black;">订单编号：</p>
			<p id="dingdanhao" style="display: inline;color: black;"></p><br />
			<p style="display: inline;color: black;">创建时间：</p>
			<p id="createdate" style="display: inline;color: black;"></p>
		</div>
		<ul class="bottom-bar mui-table-view">
			<div class="leftButton">
				<button id="cancle_lab" class="button-cancle">取消订单</button>
			</div>
			<div class="rightButton">
				<button id="submit_lab" class="button-style" style="border-color: orange;color: orange;">付款</button>
			</div>
		</ul>
		<!--</div>-->
		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/ajax.js" charset=""></script>
		<script src="../js/own.js" charset="UTF-8"></script>
		<script src="../js/common.js"></script>
		<script src="../../js/app.js"></script>

		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/ShangpinJiesuanInfo.js"></script>
		<script type="text/javascript" charset="UTF-8">
			var peopleLab = document.getElementById('people');
			var phone = document.getElementById('phone');
			var shouhuodizhi = document.getElementById('shouhuodizhi');
			var DingdanList = document.getElementById('DingdanList');
			var info = document.getElementById('info');
			var submitLab = document.getElementById('submit_lab');
			var dingdanAddressA = document.getElementById('dingdanAddress');
			var dataArray;
			var thisYizhan;
			var xiaoqu;
			var userid;
			var self;
			var pays = {};
			var w = null;
			var PAYSERVER = ALIPAYSERVER;
			mui.init();

			mui.plusReady(function() {
				console.log("-----getChannels------");
				plus.payment.getChannels(function(channels) {
					var txt = '支付通道信息：';
					for(var i in channels) {
						var channel = channels[i];
						if(channel.id == 'qhpay' || channel.id == 'qihoo') { // 过滤掉不支持的支付通道：暂不支持360相关支付
							continue;
						}
						pays[channel.id] = channel;
						txt += 'id:' + channel.id + ', ';
						txt += 'description:' + channel.description + ', ';
						txt += 'serviceReady:' + channel.serviceReady + '； ';
						//						checkServices(channel);
					}
					console.log(txt);
					//		info.innerText=txt;
				}, function(e) {
					mui.alert('获取支付通道失败：' + e.message);

				});
				self = plus.webview.currentWebview();
				dataArray = self.dataArray;
				//				thisYizhan = self.yizhanNum;
				//				userid = self.userId;
				//				xiaoqu = self.xiaoqu;
				console.log("dingdanlist：" + JSON.stringify(dataArray));
				refreshDingdan(dataArray.shangpin_info);
				peopleLab.innerText = '收货人：' + dataArray.shouhuoren_xingming;
				phone.innerText = dataArray.shouhuoren_tel;
				shouhuodizhi.innerText = '收货地址：' + dataArray.shouhuoren_address;

				submitLab.addEventListener('tap', function() {
					var danhao = dataArray.danhao;
					var total_price = dataArray.total_price
					console.log("dingdanlist：" + danhao);
					if(checkServices(pays['alipay'])) {
						var url = PAYSERVER;
						w = plus.nativeUI.showWaiting();
						var xhr = new XMLHttpRequest();
						xhr.onreadystatechange = function() {
							switch(xhr.readyState) {
								case 4:
									w.close();
									w = null;
									if(xhr.status == 200) {
										console.log('----- 请求订单成功 -----');
										console.log(xhr.responseText);
										var order = xhr.responseText;
										plus.payment.request(pays['alipay'], order, function(result) {
											console.log('----- 支付成功 -----');
											console.log(JSON.stringify(result));
											mui.openWindow({
											url: "../cart/zhifuchenggong.html",
											id: "zhifuchenggong.html",
											show: {
												autoShow: true,
												aniShow: "slide-in-right",
												duration: 100
											},
											waiting: {
												autoShow: true,
												title: '正在加载...'
											}
										});
//											plus.nativeUI.alert('支付成功：感谢你的支持，我们会继续努力。', function() {
//												//self.close();
//												//	back();
//											}, '支付');
										}, function(e) {
											console.log('----- 支付失败 -----');
											console.log('[' + e.code + ']：' + e.message);
											plus.nativeUI.alert('请重新支付！', function() {
												//self.close();
												//back();
											}, '支付失败：' + e.code);
										});
									} else {
										console.log('----- 请求订单失败 -----');
										console.log(xhr.status);
										plus.nativeUI.alert('获取订单信息失败！', null, '支付');
									}
									break;
								default:
									break;
							}
						}
						xhr.open('POST', PAYSERVER, true);
						xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
						console.log('请求支付订单：' + PAYSERVER);
						// lcc 2019/2/23 支付页面0.01元
//						var args = "total=" + 0.01 + "&subject=" + danhao + "&body=" + danhao + "&out_trade_no=" + danhao;
						var args = "total=" + total_price + "&subject=" + danhao + "&body=" + danhao + "&out_trade_no=" + danhao;
						xhr.send(args);
					}
				})

				function checkServices(pc) {
					if(!pc.serviceReady) {
						var txt = null;
						switch(pc.id) {
							case 'alipay':
								txt = '检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，请先安装应用';
								break;
							default:
								txt = '系统未安装“' + pc.description + '”服务，无法完成支付，请先安装应用';
								break;
						}
						mui.alert(txt);
						return false;
					} else {
						return true;
					}
				}
				document.getElementById("cancle_lab").addEventListener("tap", function() {
					var btnArray = ['否', '是'];
					mui.confirm('确认取消订单？', '', btnArray, function(e) {
						if(e.index == 1) {
							if(chkNetStatus() == "OK") {
								cancleItem(dataArray.danhao);
							} else
								mui.toast("网络异常");
						} else {

						}
					})

				});

			});

			function refreshDingdan(strArr) {
				console.log("dingdanlist：" + JSON.stringify(strArr));
				if(dataArray.message != '') {
					console.log("message==" + dataArray.message)
					var li = document.createElement('li');
					li.className = 'mui-table-view-cell mui-media';
					li.style.height = 'auto';
					li.style.padding = '0px';
					li.innerHTML = '<div style="width: 15%;float: left;vertical-align: middle;line-height: 80px;">\
					<span class="mui-icon iconfont icon-liuyan" style="font-size:30px;vertical-align: middle;margin-left: 18%;"></span>\
					</div>\
					<div class="mui-media-body" style="width: 85%;float: left;line-height: 1.5em;">\
					<p id="people" style="padding-top: 4%;color: black;">买家留言</p>\
					<p id="shouhuodizhi" style="word-wrap: break-word;padding-right: 4%;color: black;">无</p>\
					</div>';
					info.appendChild(li);
				}
				mui.each(strArr, function(index, item) {
					var li = document.createElement('li');
					li.className = 'mui-table-view-cell mui-media';
					li.style.height = "100px";
					li.style.padding = "0px";
					//					li.innerHTML='<div ><img src="../images/zanwutupian.png"></div>';
					li.innerHTML = '<div id = "' + item.c_no + '" onclick ="itemButton(this)"><div class="leftClassCell">\
					<img src="' + item.picture + '" class="cellImg" />\
					</div>\
					<div class="rightClassCell">\
					<p class="itemName mui-ellipsis-2">' + item.shangpin_name + '</p>\
					<p class="guige">规格:' + item.shangpin_guige + '</p>\
					<p class="price" style="color:red">¥' + item.shangpin_jiage + '</p>\
					</div>\
					<div class="ClassCell">\
					<p class="count">x' + item.shangpin_shuliang + '</p>\
					</div>';

					DingdanList.appendChild(li);
				});
				document.getElementById("total-price").innerText = '¥' + dataArray.total_price;
				document.getElementById("dingdanhao").innerText = dataArray.danhao;
				document.getElementById("createdate").innerText = dataArray.cdate;
			}

			function cancleItem(danhao) {
				var item = {};
				var arr = [];
				item.danhao = danhao;
				arr.push(item);
				mui.ajax(DELETE_DINGDAN_URL, {
					data: JSON.stringify(arr),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						var info = JSON.stringify(data);
						console.log("cancle====" + info);
						var obj = eval(data);
						if(obj.success == 1) {
							mui.toast("取消订单成功");
							var daifukuan = plus.webview.getWebviewById("daifukuan.html");
							mui.fire(daifukuan, "refresh");
							self.close();
						} else {
							var cancelOneResultMsg = obj.errorMsg;
							if(cancelOneResultMsg == ' ')
								mui.toast("取消订单失败");
							else
								mui.toast(cancelOneResultMsg);
						}

					},
					error: function(xhr, type, errorThrown) {
						document.querySelector('#not_message').style.display = 'none';
						document.querySelector('.cart_item').style.display = 'none';
						document.querySelector('#net_error').style.display = 'block';
					}

				})
			}

			function itemButton(event) {
				//var index = event.id;
				console.log("biaohao====" + event.id);
//				mui.openWindow({
//					url: '../goods/yizhanShangpinListItemDetail.html',
//					id: '../goods/yizhanShangpinListItemDetail.html',
//					show: {
//						autoShow: true,
//						aniShow: "slide-in-right",
//						duration: 100
//					},
//					waiting: {
//						autoShow: false,
//						title: '正在加载...'
//					},
//					extras: {
//						"bianhao": event.id,
//						"mendianNum": thisYizhan,
//
//					}
//				});
			}
		</script>
	</body>

</html>