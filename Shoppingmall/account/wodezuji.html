<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.shop-select-all {
				position: fixed;
				bottom: 0px;
				left: 0px;
				right: 0px;
				background: white;
				height: 44px;
				line-height: 44px;
				padding: 0px 140px 0px 15px;
				color: #fff;
				font-size: 16px;
				display: none;
			}
			
			.shanchuzuji {
				position: absolute;
				width: 90px;
				background-color: orange;
				text-align: center;
				right: 0px;
				color: #fff;
			}
			/*.head_msg {
				padding-left: 15px;
				height: 30px;
				display: table-cell;
				vertical-align: middle;
			}*/
			
			.cellImg {
				max-width: 70%;
				height: auto;
				vertical-align: middle;
				position: relative;
				left: 5px;
				padding-bottom: 0px;
			}
			
			.mui-table-view .mui-table-view-cell {
				background: white;
				padding: 0px;
				height: 110px;
			}
			
			.mui-table-view .mui-table-view-cell:after {
				left: 0px;
			}
			/*.leftClassCell {
				margin: 0 auto;
				padding-top: 5%;
				padding-left: 2%;
				width: 25%;
				float: left;
				display: table-cell;
				vertical-align: middle;
			}*/
			/*.rightClassCell {
				width: 50%;
				float: left;
			}*/
			
			.leftClassCell {
				margin: 0 auto;
				/*padding-top: 5%;*/
				padding-left: 3%;
				width: 35%;
				float: left;
				line-height: 110px;
				display: table-cell;
				vertical-align: middle;
			}
			
			.rightClassCell {
				width: 40%;
				float: left;
				padding-left: 10px;
			}
			
			.classCell {
				height: 100%;
				width: 100%;
				/*background: red;*/
				width: 25%;
				float: left;
				line-height: 100px;
				text-align: center;
			}
			
			.headSelect:visited {
				background-color: red;
			}
			
			.downDiv {
				background-color: white;
				height: 50px;
				width: 100%;
				/*网页底部*/
				position: fixed;
				bottom: 0;
			}
			
			.changeNum {
				padding: 0px;
				width: 30px;
				height: 30px;
				font-size: 30px;
			}
			
			.mui-icon.iconfont.icon-xuanze1 {
				font-size: 1.1em;
				color: darkgray;
			}
			
			.mui-icon.iconfont.icon-xuanze {
				font-size: 1.1em;
				color: orange;
				/*color: #41CEA9;*/
			}
			
			.head_title {
				vertical-align: baseline;
			}
			
			.mui-numbox {
				width: 40%;
				height: 100%;
				padding: 0px;
			}
			
			.mui-numbox [class*=mui-numbox-btn] {
				width: 30%;
				height: 100%;
				font-size: 1em;
				padding-bottom: 0.3em;
			}
			
			.itemName {
				color: black;
				line-height: 1.5em;
				margin-top: 15px;
			}
			
			.itemfeatures {
				font-size: 0.6em;
				line-height: 0.5em;
				padding-top: 3px;
			}
			
			.price {
				color: red;
				line-height: 1.2em;
				display: inline;
				margin-right: 4px;
				/*margin-top: 20px;*/
			}
			
			.guige {
				line-height: 1.2em;
			}
			/*.delete {
				color: white;
				padding-top: 0px;
				margin-top: 0px;
			}*/
			
			.delete {
				color: orange;
				padding-top: 0px;
				margin-top: 0px;
				vertical-align: middle;
				/*margin-bottom: 10px;*/
				padding: 2.5px 12px;
				border-radius: 5px;
				border-color: orange;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title"> 浏览记录</h1>
		</header>
		<div class="mui-content">

		</div>
		<div id="net_error" class="notInfo_error" style="text-align: center; margin-top: 150px;display: none;">
			<img src="../images/ic_wifi_empty.png" style="height: 100px;" />
			<br />
			<span id="word" style="color: gray; font-size: 0.9em;">网络异常</span>
			<br />
			<button type="button" class="mui-btn own-btn-green" style="margin-top: 10px; padding: 5px 20px;">重新加载</button>
		</div>
		<div id="not_message" class="notInfo" style="text-align: center; margin-top: 200px;display: none;">
			<img src="../images/ic_data_empty.png" style="height: 100px;" />
			<br />
			<span id="word1" style="color: gray; font-size: 0.9em;"></span>
		</div>
		<div id="zuji_item" class="zuji_item" style="margin-bottom: 44px;display: none;">
			<div class="table_head">
				<ul id="productItem" class="mui-table-view">
					<!--<li class="mui-table-view-cell mui-media">
						<div class="leftClassCell">
							<p style="display:inline;">
								<span class="mui-icon iconfont icon-xuanze1 selectImg"></span>
							</p>
							<img src="../images/zanwutupian.png" class="cellImg" />
						</div>
						<div class="rightClassCell">
							<p class="itemName mui-ellipsis-2">product.product_name</p>
							<p class="price">¥5</p>
						</div>
						<div class="classCell">
							<label class="price">删除足迹</label>
						</div>
					</li>-->
				</ul>
			</div>
		</div>
		<ul id="bottom-bar" class="shop-select-all mui-table-view">
			<p style="display:inline;">
				<span id="selectAll" class="mui-icon iconfont icon-xuanze1 selectImg" style="padding: 5px;font-size: 18px;"><label style="color: gray;"> 全选</label></span>
			</p>
			<!--<p style="display:inline;color: white;" id="result"></p>-->
			<label id="shanchuzuji" class="shanchuzuji">删除足迹</label>
		</ul>
	</body>
	<script src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/own.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/jquery-1.11.0.js" type="text/javascript" charset="utf-8"></script>
	<!--<script type="text/javascript" src="../js/wl_ajax.js"></script>-->
	<script type="text/javascript" charset="utf-8">
		mui.init({
			swipeBack: false
		});
		var dataListArray = new Array();
		var zujiListArray = [];
		var promotionListArray = [];
		var cartSupplierItem = [];
		var mapNormal = [];
		var calResultFromServer = [];
		var AllCuxiaoResultList = [];
		var mapResult = [];
		var list = [];
		var map = [];
		var cartWebview; //当前购物车webview
		var needlogin; //需要登录的div
		var userInfo;
		var userInfo_json;
		var yizhan_info;
		var yuanshijiage;
		var youhuijiage;
		var downDiv = document.querySelector('.downDiv');
		var result = document.getElementById('result');
		var mendianNum = localStorage.getItem(SELECTED_YIZHAN_PREFIX);
		var Filedownload;
		var bianhaoStr;
		var wait;
		var picArr = new Array();
		var deleteLab = document.getElementById('shanchuzuji');
		var selectAllBox = document.getElementById('selectAll');
		mui.plusReady(function() {
			//remarked by xinmei on 20170818
			//			Filedownload = function(netPath, index) {
			//				var dtask = plus.downloader.createDownload(netPath, {}, function(d, status) {
			//					// 下载完成 
			//					if(status == 200) {
			//						plus.io.resolveLocalFileSystemURL(d.filename, function(entry) {
			//							var downloadUrl = entry.toLocalURL();
			//							document.getElementsByClassName("cellImg")[index].src = entry.toLocalURL();
			//						});
			//					}
			//				});
			//				dtask.start();
			//			};
			//remarked end*******
			cartWebview = plus.webview.currentWebview();
			userInfo = app.getDatas(PREFERENCE_USER);
			userInfo_json = JSON.stringify(userInfo);
			yizhan_info = eval(userInfo);
			if(mendianNum == '')
				mendianNum = yizhan_info.stationno;
			load_listview(mendianNum, yizhan_info.xiaoqu, yizhan_info.id);
			document.querySelector('.notInfo_error button').addEventListener('tap', function() {
				load_listview(mendianNum, yizhan_info.xiaoqu, yizhan_info.id);
			}, false);

			mui('.shop-select-all').on('tap', 'span', function() {
				console.log("-----select All");
				selectAllItem(this);
			});
			deleteLab.addEventListener('tap', function() {
				console.log("delete bianhaoStr:" + bianhaoStr);
				var btnArray = ['否', '是'];
				if(!(bianhaoStr == null || bianhaoStr == "")) {
					mui.confirm('确认删除足迹？', '', btnArray, function(e) {
						if(e.index == 1) {
							if(chkNetStatus() == "OK") {
								deleteAll(mendianNum, yizhan_info.xiaoqu, yizhan_info.id, bianhaoStr.substring(0, bianhaoStr.length - 1));
							} else
								mui.toast("网络异常");
						} else {
							mui.toast("请先选择要删除的足迹");
						}
					});
				} else {}
			});

		});

		function deleteAll(str1, str2, str3, str4) {
			mui.ajax(Delete_Yizhan_Zuji_URL, {
				data: {
					xiaoqu: str1,
					shequ: str2,
					userid: str3,
					c_no: str4
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'get', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					var info = JSON.stringify(data);
					var obj = eval(data);
					console.log("shanchuzujiAll====" + info);
					if(obj.success == 1) {
						mui.toast("删除足迹成功");
						console.log("删除足迹成功");
						load_listview(str1, str2, str3);
					} else {
						mui.toast("删除足迹失败：" + obj.errorMsg);
						console.log("删除足迹失败：" + obj.errorMsg);
					}

				},
				error: function(xhr, type, errorThrown) {
					mui.toast("网络异常");
					mui.toast("网络异常");
					console.log("error type:" + type);
					console.log(xhr.status);
					console.log(xhr.readyState);
					console.log(xhr.response);
				}
			});
		}

		function load_listview(mendianNum, xiaoqu, userId) {
			wait = plus.nativeUI.showWaiting("正在加载，请稍候...");
			if(chkNetStatus() == "OK")
				load_query(mendianNum, xiaoqu, userId);
			else
				document.querySelector('#net_error').style.display = 'block';
		}

		function load_query(mendianNum, xiaoqu, userId) {

			mui.ajax(Query_Yizhan_Wodezuji_All_URL, {
				data: {
					xiaoqu: mendianNum,
					shequ: xiaoqu,
					userid: userId
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'get', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					var info = JSON.stringify(data);
					var obj = eval(data);
					console.log("liulanjilu====" + info);
					if(obj.success == 1) {
						wait.close();
						document.querySelector('#net_error').style.display = 'none';
						document.querySelector('#not_message').style.display = 'none';
						document.querySelector('#bottom-bar').style.display = 'block';
						document.querySelector('.zuji_item').style.display = 'block';
						dataListArray.splice(0, dataListArray.length);
						var jArr = new Array();
						jArr = obj.commodity;
						for(var i = 0; i < jArr.length; i++) {
							var item = {};
							item.dishid = jArr[i].id;
							item.bianhao = jArr[i].c_no;
							item.dishname = jArr[i].c_name;
							item.guige = jArr[i].c_describe;
							item.dishprice = jArr[i].c_price;
							item.yuanshiprice = jArr[i].c_price;
							item.cuxiaoprice = jArr[i].preferential_price;
							item.huiyuanprice = jArr[i].member_price;
							item.jiagezhuangtai = jArr[i].price_state;
							item.kucun = jArr[i].inventory;
							item.shengchanchangjia = jArr[i].Manufacturer;
							item.danwei = jArr[i].unit;
							//							console.log("ooooo===" + jArr[i].c_price);
							if(jArr[i].c_picture == '' || jArr[i].c_picture == null) {
								item.picstr = '../../images/ic_launcher.png';
							} else {
								var picstr = jArr[i].c_picture;
								var ss = new Array();
								ss = picstr.split("/");
								picstr = ss[1] + "/" + ss[2];
								item.picstr = YIZHAN_BASE_URL + picstr;
							}
							item.cuxiaoid = jArr[i].cuxiaoid;
							item.isSelected = false;
							dataListArray.push(item);

						}
						//console.log("dataListArray======" + JSON.stringify(dataListArray));
						setHtml(dataListArray);
						addTop();

					} else {
						wait.close();
						document.querySelector('.zuji_item').style.display = 'none';
						document.querySelector('#net_error').style.display = 'none';
						document.querySelector('#bottom-bar').style.display = 'none';
						document.querySelector('#not_message').style.display = 'block';
						var queryResultMsg = obj.errorMsg;

						console.log("hhhhhh" + queryResultMsg);
						if(queryResultMsg == '') {
							document.getElementById('word1').innerHTML = "获取数据失败";
						} else {
							document.getElementById('word1').innerHTML = queryResultMsg;
						}
					}

				},
				error: function(xhr, type, errorThrown) {
					wait.close();
					document.querySelector('#not_message').style.display = 'none';
					document.querySelector('.zuji_item').style.display = 'none';
					document.querySelector('#bottom-bar').style.display = 'none';
					document.querySelector('#net_error').style.display = 'block';
					mui.toast("网络异常");
					console.log("error type:" + type);
					console.log(xhr.status);
					console.log(xhr.readyState);
					console.log(xhr.response);
				}
			});
		}

		function addTop() {
			mui('.mui-table-view').on('tap', 'span', function() {
				selectItem(this);
			});
		}

		function deleteButton(o) { //单个删除足迹
			console.log("uuuu")
			zujiListArray = [];
			document.getElementById('delete' + o.parentNode.id);
			var btnArray = ['否', '是'];
			mui.confirm('确认删除？', '', btnArray, function(e) {
				if(e.index == 1) {
					if(chkNetStatus() == "OK") {
						deleteItem(mendianNum, yizhan_info.xiaoqu, yizhan_info.id, "\'" + dataListArray[o.parentNode.id].bianhao + "\'", o);
					} else
						mui.toast("网络异常");
				} else {

				}
			});
		}

		function itemXiangqing(id) {
			console.log("xiangqing id=====" + id);
			var index = id.split("_")[1];
			var cuxiaoid = dataListArray[index].cuxiaoid;
			var shangpinNum = dataListArray[index].bianhao;
			console.log("shangpinbiaohao====" + shangpinNum + ",id:" + cuxiaoid);
			if(cuxiaoid == "0") {
				mui.openWindow({
					url: '../goods/yizhanShangpinListItemDetail.html',
					id: 'yizhanShangpinListItemDetail.html',
					show: {
						autoShow: true,
						aniShow: "slide-in-right",
						duration: 100
					},
					waiting: {
						autoShow: false,
						title: '正在加载...'
					},
					extras: {
						"bianhao": shangpinNum,
						"mendianNum": mendianNum
						//	"cuxiaofanganbianhao": cuxiaofanganbianhao
					}
				});
			} else {
				mui.openWindow({
					url: '../goods/yizhanCuxiaoListItemDetail.html',
					id: 'yizhanCuxiaoListItemDetail.html',
					show: {
						autoShow: true,
						aniShow: "slide-in-right",
						duration: 100
					},
					waiting: {
						autoShow: false,
						title: '正在加载...'
					},
					extras: {
						"bianhao": shangpinNum,
						"mendianNum": mendianNum,
						"cuxiaofanganbianhao": cuxiaoid
					}
				});
			}

		}

		function stopEvt(event) {
			event.stopPropagation(); //阻止点击事件向上冒泡  
		}

		function deleteItem(mendian, xiaoqu, userId, bianhao, o) {
			console.log("bianhao===" + bianhao);
			mui.ajax(Delete_Yizhan_Zuji_URL, {
				data: {
					xiaoqu: mendian,
					shequ: xiaoqu,
					userid: userId,
					c_no: bianhao
				},
				async: false,
				dataType: 'json', //服务器返回json格式数据
				type: 'get', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				header: {
					'Content-Type': 'application/json'
				},
				success: function(data) {
					var info = JSON.stringify(data);
					var obj = eval(data);
					console.log("deleteInfo===" + info);
					if(obj.success == 1) {
						mui.toast("删除成功");
						console.log("删除成功");
						if(dataListArray.length > 1) {
							var parent = o.parentNode.parentNode.parentNode.parentNode.parentNode;
							console.log("jiedian====" + parent);
							var child = o.parentNode.parentNode.parentNode.parentNode;
							parent.removeChild(child);
							load_listview(mendianNum, yizhan_info.xiaoqu, yizhan_info.id);
							refreshPopView();
						} else {
							load_listview();
						}
					} else {
						deleteResultMsg = obj.errorMsg;
						if(deleteResultMsg == '')
							mui.toast("删除失败");
						else
							mui.toast(deleteResultMsg);

					}
				},
				error: function(xhr, type, errorThrown) {
					mui.toast("网络异常");
				}

			});

		}

		function setHtml(items) {
			//console.log(items.length);
			var loginDiv = document.querySelector('.zuji_item');
			var html = '';
			mui.each(items, function(index, item) {
				//				Filedownload(item.picstr);
				var listDiv = '';
				listDiv += '<div  id ="item_' + index + '" class="table_head' + index + '" onclick="itemXiangqing(this.id)">';
				listDiv += '<ul class="mui-table-view">';
				var listCellStr = '';
				listCellStr += '<li class="mui-table-view-cell mui-media">';
				//左边div
				var leftCellDiv = '';
				leftCellDiv += '<div class="leftClassCell">';
				leftCellDiv += '<p style="display:inline;"><span id="productItem_' + index + '" onclick="stopEvt(event)" class="mui-icon iconfont icon-xuanze1 selectImg" style="padding: 7px;font-size: 18px;"></span></p>';
				leftCellDiv += '<img  src="' + item.picstr + '" class="cellImg" />';
				leftCellDiv += '</div>';
				listCellStr += leftCellDiv;
				//右边div
				var rightCellDiv = '';
				rightCellDiv += '<div class="rightClassCell">';
				rightCellDiv += '<p id = "name" class="itemName mui-ellipsis-2">' + item.dishname + '</p><p class="guige">规格:' + item.guige + '</p>';
				rightCellDiv += '<p class="price">' + '¥' + item.huiyuanprice + '</p>';
				//				rightCellDiv += '<div style ="width: 100px" id =' + index + ' class="mui-numbox" data-numbox-min=' + 1 + '><button  onclick="minusButton(this);stopEvt(event)" class="mui-btn mui-numbox-btn-minus" type="button">-</button><input  id ="numbox' + index + '" class="mui-numbox-input"readonly="readonly" onclick="stopEvt(event)" type="number" value="' + item.goumaishuliang + '"/><button id ="nn" href="#" onclick="addButton(this);stopEvt(event)" class="mui-btn mui-numbox-btn-plus" type="button">+</button></div>';
				rightCellDiv += '</div><div id =' + index + ' class="classCell"><button id =delete' + index + ' onclick="deleteButton(this);stopEvt(event)" class="delete">删除足迹</button></div>';
				listCellStr += rightCellDiv;
				listCellStr += '</li>';

				listDiv += listCellStr + '</ul>';

				listDiv += '</div>'

				html += listDiv;

				//				Filedownload(item.picstr, index);//remarked by xinmei on 20170818
			});
			//console.log(html);

			loginDiv.innerHTML = html;
		}

		function selectAllItem(obj) {
			zujiListArray = [];
			var isXuanze = obj.classList.contains('icon-xuanze1');
			if(isXuanze) {
				obj.className = "mui-icon iconfont icon-xuanze selectImg";
				for(var i = 0; i < dataListArray.length; i++) {
					var id = "productItem_" + i;
					document.querySelector('#' + id).className = "mui-icon iconfont icon-xuanze selectImg";
				}
			} else {
				obj.className = "mui-icon iconfont icon-xuanze1 selectImg";
				for(var i = 0; i < dataListArray.length; i++) {
					var id = "productItem_" + i;
					document.querySelector('#' + id).className = "mui-icon iconfont icon-xuanze1 selectImg";
				}
			}
			refreshPopView();
		}

		function selectItem(obj) {
			zujiListArray = [];
			//			var inputNumbox = document.getElementById('numbox' + obj.id.split("_")[1]);
			//			dataListArray[obj.id.split("_")[1]].goumaishuliang = inputNumbox.value;
			var isXuanze = obj.classList.contains('icon-xuanze1');
			if(isXuanze) {
				obj.className = "mui-icon iconfont icon-xuanze selectImg";
			} else {
				obj.className = "mui-icon iconfont icon-xuanze1 selectImg";
			}
			if(checkItemState(obj)) {
				document.querySelector('#selectAll').className = "mui-icon iconfont icon-xuanze selectImg";
			} else
				document.querySelector('#selectAll').className = "mui-icon iconfont icon-xuanze1 selectImg";
			refreshPopView();
		}

		function refreshPopView() {
			bianhaoStr = "";
			for(var i = 0; i < dataListArray.length; i++) {
				var id = "productItem_" + i;
				if($('#' + id).hasClass('icon-xuanze')) {
					bianhaoStr += "\'" + dataListArray[i].bianhao + "\'" + ",";
				}
			}
			//			calResult_query(zujiListArray, mendianNum);
		}

		function checkItemState(obj) {
			for(var i = 0; i < dataListArray.length; i++) {
				var id = "productItem_" + i;
				if($('#' + id).hasClass('icon-xuanze1')) {
					return false;
				}
			}
			return true;

		}
	</script>

</html>